<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Calculadora de Preço Ideal</title>
    
    <!-- React e ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    
    <!-- React Router -->
    <script src="https://unpkg.com/react-router-dom@5.2.0/umd/react-router-dom.min.js"></script>
    
    <!-- Babel para transformar JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div id="root" class="min-vh-100 bg-light"></div>

    <script type="text/babel">
        // Função de cálculo (simulando backend)
        function calcularPrecoIdeal(custoFixo, margemLucro, assinantes) {
            if (!custoFixo || !margemLucro || !assinantes) {
                throw new Error('Todos os campos são obrigatórios.');
            }

            const precoIdeal = (custoFixo / assinantes) * (1 + margemLucro / 100);
            return precoIdeal.toFixed(2);
        }

        // Componente de Cálculo de Preço Ideal
        function PrecoIdeal() {
            const [custoFixo, setCustoFixo] = React.useState('');
            const [margemLucro, setMargemLucro] = React.useState('');
            const [assinantes, setAssinantes] = React.useState('');
            const [resultado, setResultado] = React.useState(null);
            const [erro, setErro] = React.useState(null);
            const [graficoData, setGraficoData] = React.useState(null);

            const handleCalcular = (e) => {
                e.preventDefault();
                try {
                    const preco = calcularPrecoIdeal(
                        parseFloat(custoFixo), 
                        parseFloat(margemLucro), 
                        parseFloat(assinantes)
                    );
                    setResultado(preco);
                    setErro(null);

                    // Atualizando o gráfico com o resultado
                    setGraficoData({
                        labels: ['Preço Ideal'],
                        datasets: [{
                            label: 'Preço Ideal (R$)',
                            data: [preco],
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                        }]
                    });
                } catch (error) {
                    setErro(error.message);
                    setResultado(null);
                }
            };
            
            
            
            // No useEffect do gráfico, antes de acessar o payload, adicione um log para verificar os dados:
React.useEffect(() => {
    console.log("graficoData", graficoData);  // Log para inspecionar a estrutura dos dados

    if (graficoData) {
        const ctx = document.getElementById('precoIdealChart').getContext('2d');

        // Se já existe um gráfico, destrua o gráfico anterior
        if (window.myChart) {
            window.myChart.destroy();
        }

        window.myChart = new Chart(ctx, {
            type: 'bar',
            data: graficoData,
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        enabled: false,
                        external: function(context) {
                            const tooltipModel = context.tooltip;

                            if (tooltipModel.body) {
                                const precoIdeal = localStorage.getItem('precoIdeal') || 'N/A';
                                const custoFixo = localStorage.getItem('custo') || 'N/A';
                                
                                const tooltipEl = document.getElementById('chartjs-tooltip');
                                if (!tooltipEl) {
                                    const newTooltip = document.createElement('div');
                                    newTooltip.id = 'chartjs-tooltip';
                                    newTooltip.classList.add('bg-white', 'text-gray-800', 'shadow-lg', 'rounded-lg', 'p-3', 'border', 'border-gray-200');
                                    document.body.appendChild(newTooltip);
                                }
                                
                                const dataPoint = tooltipModel.dataPoints[0].raw;
                                console.log("dataPoint", dataPoint);  // Verifique os dados aqui

                                const totalGanho = dataPoint.totalGanho ? dataPoint.totalGanho.toFixed(2) : 'N/A';
                                const preco = dataPoint.preco ? dataPoint.preco.toFixed(2) : 'N/A';
                                const assinantes = dataPoint.assinantes || 'N/A';

                              
                          
                              

                                const position = context.chart.canvas.getBoundingClientRect();
                                tooltipEl.style.left = position.left + tooltipModel.caretX + 'px';
                                tooltipEl.style.top = position.top + tooltipModel.caretY + 'px';
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    x: {
                        type: 'category',
                    },
                    y: {
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value;
                            }
                        }
                    }
                }
            }
        });
    }

    return () => {
        if (window.myChart) {
            window.myChart.destroy();
        }
    };
}, [graficoData]);



            

            return (
                <div className="container py-5">
                    <div className="card mx-auto" style={{maxWidth: '400px'}}>
                        <h1 className="card-header text-center">Calculadora de Preço Ideal</h1>
                        <div className="card-body">
                            <form onSubmit={handleCalcular} className="mb-3">
                                <div className="mb-3">
                                    <label className="form-label">Custo Fixo (R$)</label>
                                    <input 
                                        type="number" 
                                        value={custoFixo}
                                        onChange={(e) => setCustoFixo(e.target.value)}
                                        placeholder="Digite o custo fixo"
                                        className="form-control"
                                        required
                                    />
                                </div>
                                <div className="mb-3">
                                    <label className="form-label">Margem de Lucro (%)</label>
                                    <input 
                                        type="number" 
                                        value={margemLucro}
                                        onChange={(e) => setMargemLucro(e.target.value)}
                                        placeholder="Digite a margem de lucro"
                                        className="form-control"
                                        required
                                    />
                                </div>
                                <div className="mb-3">
                                    <label className="form-label">Número de Assinantes</label>
                                    <input 
                                        type="number" 
                                        value={assinantes}
                                        onChange={(e) => setAssinantes(e.target.value)}
                                        placeholder="Digite o número de assinantes"
                                        className="form-control"
                                        required
                                    />
                                </div>
                                <button 
                                    type="submit" 
                                    className="btn btn-primary w-100"
                                >
                                    Calcular Preço Ideal
                                </button>
                            </form>

                            {erro && (
                                <div className="alert alert-danger">
                                    {erro}
                                </div>
                            )}

                            {resultado && (
                                <div className="alert alert-success">
                                    <strong>Preço Ideal:</strong> R$ {resultado}
                                </div>
                            )}

                            {resultado && graficoData && (
                                <div className="mt-4">
                                    <canvas id="precoIdealChart"></canvas>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Página Inicial
        function LandingPage() {
            const history = ReactRouterDOM.useHistory();

            return (
                <div className="min-vh-100 d-flex justify-content-center align-items-center bg-light">
                    <div className="text-center">
                        <h1 className="display-4 mb-4">Bem-vindo à Calculadora de Preço Ideal</h1>
                        <p className="mb-5 lead text-muted">
                            Calcule o preço ideal para sua assinatura ou serviço
                        </p>
                        <button 
                            onClick={() => history.push('/calc')}
                            className="btn btn-primary btn-lg"
                        >
                            Iniciar Cálculo
                        </button>
                    </div>
                </div>
            );
        }

        // Componente Principal com Roteamento
        function App() {
            return (
                <ReactRouterDOM.HashRouter>
                    <ReactRouterDOM.Switch>
                        <ReactRouterDOM.Route exact path="/" component={LandingPage} />
                        <ReactRouterDOM.Route path="/calc" component={PrecoIdeal} />
                    </ReactRouterDOM.Switch>
                </ReactRouterDOM.HashRouter>
            );
        }

        // Renderização
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
  </html>
